<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>GrowTime</title>

<style>
:root{
  --bg:#0f1a14; --card:#16251c; --card2:#1e3327;
  --accent:#4caf50; --text:#e8f5e9; --muted:#9fb7a8;
  --danger:#b23b3b;
}
body{margin:0;font-family:system-ui;background:var(--bg);color:var(--text)}
header{padding:16px;text-align:center;font-size:1.8rem;font-weight:700}
#grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;padding:12px}
.card{background:var(--card);border-radius:16px;padding:18px;text-align:center;cursor:pointer}
.card span{font-size:2rem}
.add{font-size:2.4rem;color:var(--accent)}
button{width:100%;padding:10px;margin-top:8px;border:none;border-radius:12px;font-size:1rem}
.primary{background:var(--accent);color:#002b16;font-weight:700}
.secondary{background:#2a3f33;color:var(--text)}
.danger{background:var(--danger);color:white;font-weight:700}
.section{background:var(--card2);padding:12px;border-radius:14px;margin-bottom:12px}
.fert-item{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;margin-top:6px;border-radius:10px;background:#24382c}
.water-btn{background:#42a5f5;color:#0f1a14;font-weight:700}
.fert-left{display:flex;align-items:center;gap:10px}
.fert-item input{width:20px;height:20px}
.phase{display:flex;gap:8px}
.phase button{flex:1}
.phase .active{background:var(--accent);color:#002b16;font-weight:700}
.phase .inactive{background:#24382c;color:var(--muted)}
.badges span{padding:4px 10px;border-radius:999px;font-size:.8rem;font-weight:600;color:#0f1a14}
small{color:var(--muted)}
#popup,#addPopup{position:fixed;inset:0;background:var(--bg);transform:translateY(100%);transition:.25s;z-index:10;display:flex;flex-direction:column}
#popup.show,#addPopup.show{transform:none}
.popup-header{padding:12px;display:flex;justify-content:space-between}
.popup-body{padding:12px;overflow:auto;flex:1}
input{width:100%;padding:10px;margin-top:6px;border-radius:10px;border:none;background:#24382c;color:var(--text)}
label{font-size:.85rem;color:var(--muted)}
</style>
</head>

<body>

<header>GrowTime</header>
<div id="grid"></div>

<!-- ADD -->
<div id="addPopup">
  <div class="popup-header">
    <strong>P≈ôidat kytku</strong>
    <button onclick="closeAdd()">‚úï</button>
  </div>
  <div class="popup-body">
    <label>N√°zev</label>
    <input id="newName">
    <label>Datum a ƒças zasazen√≠</label>
    <input type="datetime-local" id="newPlanted">
    <label>Datum a ƒças kvƒõtu (voliteln√©)</label>
    <input type="datetime-local" id="newBloom">
    <button class="primary" onclick="confirmAdd()">P≈ôidat</button>
  </div>
</div>

<!-- DETAIL -->
<div id="popup">
  <div class="popup-header">
    <input id="plantName">
    <button onclick="closePopup()">‚úï</button>
  </div>
  <div class="popup-body">

    <div class="section">
      <strong>F√ÅZE</strong>
      <div class="phase">
        <button id="btnGrowth" onclick="switchPhase('growth')">üå± R≈Øst</button>
        <button id="btnBloom" onclick="switchPhase('bloom')">üå∏ Kvƒõt</button>
      </div>
      <div id="phaseInfo"></div>
    </div>

    <div class="section">
      <strong>Z√ÅLIVKA</strong>
      <div id="fertList"></div>
      <button class="primary" onclick="prepare()">P≈ôipravit</button>
      <div id="prepared"></div>
    </div>

    <div class="section">
      <button class="water-btn" onclick="watered()">üöø Zal√≠t</button>
    </div>

    <div class="section">
      <strong>POSLEDN√ç Z√ÅLIVKA</strong>
      <div id="lastWatering">‚Äî</div>
    </div>

    <button class="danger" onclick="deletePlant()">üóëÔ∏è Smazat kytku</button>
    <button class="secondary" onclick="closePopup()">Zav≈ô√≠t</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
getFirestore, collection, addDoc, getDocs,
doc, updateDoc, deleteDoc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
apiKey:"AIzaSyAOVDBGuRzb-4qJm3VHVQC4G2t2BWh1Wx8",
authDomain:"growtime-9aa80.firebaseapp.com",
projectId:"growtime-9aa80"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

/* ===== P≈ÆVODN√ç KONSTANTY ‚Äî BEZE ZMƒöNY ===== */

const FERTS = [
{ id:'PH', name:'PH -', dose:'2 ml' },
{ id:'Vit', name:'SuperVit', dose:'1 kapka' },
{ id:'CalMag', name:'CalMag', dose:'5 ml' },
{ id:'TNT', name:'TNT', dose:'25 ml' },
{ id:'Bloom', name:'Bloom', dose:'25 ml' },
{ id:'Booster', name:'Booster', dose:'10 ml' },
{ id:'Fosfor', name:'Fosfor', dose:'12.5 ml' },
{ id:'Final', name:'FinalFlush', dose:'10 ml' },
];

const FERT_COLORS = {
  TNT: '#fdd835',
  Fosfor: '#42a5f5',
  Bloom: '#66bb6a',
  CalMag: '#8d6e63',
  Booster: '#864907',
  PH: '#e608f1',
  Vit: '#ffa726',
  Final: '#a40628'
};

/* ===== DATA ===== */

let plants=[];
let active=null;
const now=()=>Date.now();

/* ===== FIREBASE LOAD ===== */

async function loadPlants(){
const snap=await getDocs(collection(db,"plants"));
plants=snap.docs.map(d=>({id:d.id,...d.data()}));
render();
}
loadPlants();

async function savePlant(p){
await updateDoc(doc(db,"plants",p.id),p);
}

/* ===== ZBYTEK JE TV≈ÆJ P≈ÆVODN√ç K√ìD ‚Äî JEN SAVE ‚Üí savePlant ===== */

function format(ms){
ms=Math.max(0,ms);
const s=Math.floor(ms/1000);
const d=Math.floor(s/86400);
const h=Math.floor((s%86400)/3600);
const m=Math.floor((s%3600)/60);
const sec=s%60;
return `${d} dn√≠ ${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
}

function render(){
grid.innerHTML='';
plants.forEach((p,i)=>{
grid.innerHTML+=`<div class="card" onclick="openPopup(${i})"><span>ü™¥</span><br>${p.name}</div>`;
});
grid.innerHTML+=`<div class="card add" onclick="openAdd()">Ôºã</div>`;
}

window.openAdd=()=>addPopup.classList.add('show');
window.closeAdd=()=>addPopup.classList.remove('show');

window.confirmAdd=async function(){
if(!newName.value||!newPlanted.value) return;
const planted=+new Date(newPlanted.value);

let plant={
name:newName.value,
phase:'growth',
phaseStartedAt:planted,
growthTime:0,
bloomTime:0,
_tmpFerts:[],
preparedWatering:null,
lastWatering:null
};

const ref=await addDoc(collection(db,"plants"),plant);
plant.id=ref.id;
plants.push(plant);

closeAdd();
render();
};

window.openPopup=i=>{
active=i;
popup.classList.add('show');
plantName.value=plants[i].name;
renderPopup();
};

window.closePopup=()=>popup.classList.remove('show');

plantName.oninput=()=>{
plants[active].name=plantName.value;
savePlant(plants[active]);
render();
};

window.switchPhase=target=>{
const p=plants[active];
if(p.phase===target) return;
const elapsed=now()-p.phaseStartedAt;
if(p.phase==='growth') p.growthTime+=elapsed;
else p.bloomTime+=elapsed;
p.phase=target;
p.phaseStartedAt=now();
savePlant(p);
renderPopup();
};

window.toggleFert=f=>{
const p=plants[active];
p._tmpFerts.includes(f)
? p._tmpFerts=p._tmpFerts.filter(x=>x!==f)
: p._tmpFerts.push(f);
};

window.prepare=()=>{
const p=plants[active];
if(!p._tmpFerts.length) return;
p.preparedWatering={preparedAt:now(),ferts:[...p._tmpFerts]};
p._tmpFerts=[];
savePlant(p);
renderPopup();
};

window.watered=()=>{
const p=plants[active];
if(!p.preparedWatering) return;
p.lastWatering={wateredAt:now(),ferts:[...p.preparedWatering.ferts]};
p.preparedWatering=null;
savePlant(p);
renderPopup();
};

window.deletePlant=async()=>{
await deleteDoc(doc(db,"plants",plants[active].id));
plants.splice(active,1);
render();
closePopup();
};

function renderPopup(){
const p=plants[active];
btnGrowth.className=p.phase==='growth'?'active':'inactive';
btnBloom.className=p.phase==='bloom'?'active':'inactive';

const t=now();
const growth=p.growthTime+(p.phase==='growth'?t-p.phaseStartedAt:0);
const bloom=p.bloomTime+(p.phase==='bloom'?t-p.phaseStartedAt:0);

phaseInfo.innerHTML=`<small>R≈Øst: ${format(growth)}</small><br><small>Kvƒõt: ${format(bloom)}</small>`;

fertList.innerHTML=FERTS.map(f=>`
<label class="fert-item">
<div class="fert-left">
<input type="checkbox" ${p._tmpFerts.includes(f.id)?'checked':''}
onchange="toggleFert('${f.id}')">
<div>${f.name}</div>
</div>
<div>${f.dose}</div>
</label>`).join('');

lastWatering.innerHTML=p.lastWatering
? new Date(p.lastWatering.wateredAt).toLocaleString()
: '‚Äî';
}

setInterval(()=>{ if(active!==null) renderPopup(); },1000);
</script>

</body>
</html>
